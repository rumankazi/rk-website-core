name: Workflow Security Analysis

on:
  push:
    branches: [main, develop]
    paths: ['.github/workflows/**', '.github/dependabot.yml']
  pull_request:
    branches: [main, develop]
    paths: ['.github/workflows/**', '.github/dependabot.yml']
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: read

jobs:
  workflow-security:
    name: GitHub Actions Security Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq for JSON processing
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Validate workflow syntax
        run: |
          echo "🔍 Validating GitHub Actions workflow syntax..."
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [[ -f "$workflow" ]]; then
              echo "Checking $workflow..."
              # Basic YAML syntax validation
              python3 -c "import yaml; yaml.safe_load(open('$workflow'))" || {
                echo "❌ YAML syntax error in $workflow"
                exit 1
              }
            fi
          done
          echo "✅ All workflows have valid YAML syntax"

      - name: Check for required permissions
        run: |
          echo "🔍 Checking for missing permissions in workflows..."
          missing_perms=0

          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [[ -f "$workflow" ]]; then
              # Skip this workflow and template workflows
              if [[ "$workflow" == *"zizmor.yml"* ]] || [[ "$workflow" == *"template"* ]]; then
                continue
              fi
              
              echo "Checking permissions in $workflow..."
              if ! grep -q "permissions:" "$workflow"; then
                echo "⚠️  Missing permissions block in $workflow"
                missing_perms=1
              fi
            fi
          done

          if [[ $missing_perms -eq 1 ]]; then
            echo "❌ Some workflows are missing permissions blocks"
            echo "This workflow will now run Zizmor to provide detailed security analysis"
          else
            echo "✅ All workflows have permissions blocks"
          fi

      - name: Run Zizmor security analysis
        uses: zizmorcore/zizmor-action@v0.2.0
        with:
          # Run on all workflow files in the repository
          inputs: '.github/workflows/'
          # Enable GitHub Advanced Security integration
          advanced-security: true
          # Run online audits for more comprehensive analysis
          online-audits: true
          # Use regular persona (balanced approach)
          persona: regular

      - name: Check for common security issues
        run: |
          echo "🔍 Checking for common workflow security issues..."

          issues_found=0

          echo "Checking for hardcoded secrets..."
          if grep -r -i "password\|secret\|token\|key" .github/workflows/ --include="*.yml" --include="*.yaml" | grep -v "secrets\." | grep -v "GITHUB_TOKEN" | grep -v "github.token"; then
            echo "⚠️  Potential hardcoded secrets found"
            issues_found=1
          fi

          echo "Checking for overly permissive permissions..."
          if grep -r "permissions:" .github/workflows/ -A 10 | grep -E "write-all|admin"; then
            echo "⚠️  Overly permissive permissions found"
            issues_found=1
          fi

          echo "Checking for unverified third-party actions..."
          if grep -r "uses:" .github/workflows/ | grep -v "@v[0-9]\|@main\|@master" | grep -v "actions/\|github/"; then
            echo "⚠️  Third-party actions without version pinning found"
            issues_found=1
          fi

          if [[ $issues_found -eq 0 ]]; then
            echo "✅ No common security issues detected"
          else
            echo "⚠️  Please review the security issues found above"
            echo "Consider following GitHub Actions security best practices:"
            echo "- Use secrets.* for sensitive data"
            echo "- Minimize permissions to the required scope"
            echo "- Pin third-party actions to specific versions or commit SHAs"
          fi

      - name: Generate security report
        if: always()
        run: |
          echo "📊 Workflow Security Report" > security-report.md
          echo "=========================" >> security-report.md
          echo "" >> security-report.md
          echo "**Analysis Date**: $(date -u)" >> security-report.md
          echo "**Commit**: ${{ github.sha }}" >> security-report.md
          echo "" >> security-report.md

          echo "## Workflows Analyzed" >> security-report.md
          for workflow in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [[ -f "$workflow" ]]; then
              echo "- $workflow" >> security-report.md
            fi
          done

          echo "" >> security-report.md
          echo "## Security Tools Used" >> security-report.md
          echo "- **Zizmor**: GitHub Actions security scanner" >> security-report.md
          echo "- **Custom checks**: Permissions, secrets, third-party actions" >> security-report.md
          echo "" >> security-report.md
          echo "## Results" >> security-report.md
          echo "See the Security tab for detailed SARIF results from Zizmor analysis." >> security-report.md

          echo "📋 Security report generated"

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workflow-security-report
          path: security-report.md
          retention-days: 30
